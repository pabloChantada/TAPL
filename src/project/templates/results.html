<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resultados de Entrevista</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .metric-card {
            transition: transform .2s
        }

        .metric-card:hover {
            transform: translateY(-4px)
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip-content {
            animation: fadeIn 0.2s ease-out;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
    <div id="root">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">Cargando resultados...</p>
            </div>
        </div>
    </div>
    
    <script id="initial-data" type="application/json">
{{ data | tojson }}
    </script>

    <script type="text/babel">
        const { useState } = React;

        // Componente Tooltip
        const Tooltip = ({ text }) => {
            const [show, setShow] = useState(false);

            return (
                <div className="relative inline-block">
                    <button
                        onMouseEnter={() => setShow(true)}
                        onMouseLeave={() => setShow(false)}
                        onClick={(e) => {
                            e.preventDefault();
                            setShow(!show);
                        }}
                        className="ml-2 text-indigo-500 hover:text-indigo-700 cursor-help"
                        type="button"
                    >
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12. 01" y2="8"></line>
                        </svg>
                    </button>
                    {show && (
                        <div className="tooltip-content absolute z-50 bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-72 p-4 bg-gray-900 text-white text-sm rounded-lg shadow-2xl">
                            {text}
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                <div className="border-8 border-transparent border-t-gray-900"></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const RefreshIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3. 51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        );

        const MetricCard = ({ title, value, color, desc, tooltipText }) => (
            <div className={`metric-card bg-white rounded-xl shadow-lg p-6 border-l-4 ${color}`}>
                <div className="flex items-center justify-between">
                    <h3 className="text-sm font-medium text-gray-600">{title}</h3>
                    {tooltipText && <Tooltip text={tooltipText} />}
                </div>
                <p className="text-3xl font-bold mt-2">{value}</p>
                {desc && <p className="text-xs text-gray-500 mt-1">{desc}</p>}
            </div>
        );

        const ResultsPage = ({ data }) => {
            const { bleu, rouge, bertscore, answers, total_questions, dataset_type } = data;

            return (
                <div className="max-w-5xl mx-auto">
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-gray-800">Resultados de la Entrevista</h1>
                        <p className="text-gray-600 mt-2">Evaluación automática con métricas NLP</p>
                        {dataset_type && (
                            <div className="inline-block mt-3 px-4 py-2 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                                Dataset: {dataset_type. toUpperCase()}
                            </div>
                        )}
                    </div>

                    {/* Métricas principales */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <MetricCard 
                            title="BLEU" 
                            value={bleu ??  0} 
                            color="border-blue-500" 
                            desc="Similitud léxica"
                            tooltipText="BLEU (Bilingual Evaluation Understudy) mide la coincidencia exacta de palabras entre tu respuesta y la respuesta correcta. Un valor más alto indica mayor precisión textual (0-1)."
                        />
                        <MetricCard 
                            title="ROUGE-L" 
                            value={rouge?.rougeL ?? 0} 
                            color="border-green-500" 
                            desc="Secuencias más largas"
                            tooltipText="ROUGE-L evalúa las secuencias de palabras más largas que coinciden entre tu respuesta y la correcta.  Mide fluidez y coherencia (0-1)."
                        />
                        <MetricCard 
                            title="BERTScore (F1)" 
                            value={bertscore ??  0} 
                            color="border-purple-500" 
                            desc="Similitud semántica"
                            tooltipText="BERTScore usa modelos de lenguaje avanzados (BERT) para medir similitud semántica, no solo palabras exactas. Captura el significado incluso si usas sinónimos o parafraseas (0-1)."
                        />
                    </div>

                    {/* Detalle ROUGE */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="text-xl font-semibold">Detalles ROUGE</h2>
                            <Tooltip text="ROUGE incluye múltiples variantes: rouge1 (unigramas), rouge2 (bigramas), rougeL (secuencias largas) y rougeLsum (resúmenes).  Cada una evalúa aspectos diferentes de la coincidencia textual." />
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            {rouge && Object.entries(rouge).map(([k, v]) => (
                                <div key={k} className="bg-gray-50 rounded-lg p-3">
                                    <p className="text-xs text-gray-600 uppercase">{k}</p>
                                    <p className="text-lg font-bold text-gray-800">{v ??  0}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Respuestas */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-xl font-semibold mb-4">
                            Respuestas Completas ({total_questions})
                        </h2>
                        <div className="space-y-4">
                            {answers && answers.length > 0 ? answers.map((a, i) => (
                                <details key={i} className="border rounded-lg p-4 bg-gray-50 cursor-pointer hover:bg-gray-100 transition">
                                    <summary className="font-medium text-indigo-700 cursor-pointer">
                                        Pregunta {a.question_number}: {a. question}
                                    </summary>
                                    <div className="mt-3 pl-4 border-l-2 border-indigo-300 space-y-2">
                                        <p className="text-sm text-gray-700">
                                            <strong>Tu respuesta:</strong> {a. answer}
                                        </p>
                                        {a.correct_answer && (
                                            <p className="text-sm text-green-700">
                                                <strong>Respuesta correcta:</strong> {a.correct_answer}
                                            </p>
                                        )}
                                    </div>
                                </details>
                            )) : (
                                <p className="text-gray-500 text-center">No hay respuestas disponibles</p>
                            )}
                        </div>
                    </div>

                    {/* Botones de acción */}
                    <div className="flex gap-4 justify-center mt-8">
                        <a 
                            href="/" 
                            className="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition shadow-lg"
                        >
                            <RefreshIcon />
                            Nueva Entrevista
                        </a>
                        <button
                            onClick={() => window.print()}
                            className="inline-flex items-center gap-2 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition"
                        >
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                <rect x="6" y="14" width="12" height="8"></rect>
                            </svg>
                            Imprimir Resultados
                        </button>
                    </div>
                </div>
            );
        };

        // Manejo seguro del JSON con mejor logging
        try {
            console.log('[Results] Iniciando carga de resultados...');
            
            const dataElement = document.getElementById('initial-data');
            if (! dataElement) {
                throw new Error('No se encontró el elemento con los datos (initial-data)');
            }
            
            console.log('[Results] Elemento de datos encontrado');
            const textContent = dataElement.textContent;
            console.log('[Results] Contenido del elemento:', textContent. substring(0, 200) + '...');
            
            const rawData = JSON.parse(textContent);
            console.log('[Results] Datos parseados correctamente:', rawData);
            
            const root = ReactDOM.createRoot(document.getElementById('root'));
            console.log('[Results] Renderizando componente...');
            root.render(<ResultsPage data={rawData} />);
            console.log('[Results] Resultados cargados exitosamente');
            
        } catch (error) {
            console.error('[Results] Error cargando resultados:', error);
            console.error('[Results] Stack trace:', error.stack);
            
            document.getElementById('root').innerHTML = `
                <div class="max-w-2xl mx-auto mt-10 p-6 bg-red-50 border border-red-200 rounded-lg">
                    <h2 class="text-xl font-bold text-red-800 mb-2">Error al cargar resultados</h2>
                    <p class="text-red-600 mb-4">${error.message}</p>
                    <details class="mb-4">
                        <summary class="cursor-pointer text-sm font-medium text-red-700">Ver detalles técnicos</summary>
                        <pre class="mt-2 p-3 bg-red-100 rounded text-xs overflow-auto">${error.stack || 'No stack trace available'}</pre>
                    </details>
                    <a href="/" class="inline-block px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        Volver al inicio
                    </a>
                </div>
            `;
        }
    </script>
</body>

</html>