<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resultados de Entrevista</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .metric-card {
            transition: transform .2s
        }

        .metric-card:hover {
            transform: translateY(-4px)
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">

    <div id="root"></div>

    <script id="initial-data" type="application/json">{{ data | tojson | safe }}</script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /* ======================================================
           TARJETA DE M칄TRICAS
        ====================================================== */
        const MetricCard = ({ title, value, color, desc }) => (
            <div className={`metric-card bg-white rounded-xl shadow-lg p-6 border-l-4 ${color}`}>
                <h3 className="text-sm font-medium text-gray-600">{title}</h3>
                <p className="text-3xl font-bold mt-2">{value}</p>
                {desc && <p className="text-xs text-gray-500 mt-1">{desc}</p>}
            </div>
        );

        /* ======================================================
           COMPONENTE: FEEDBACK LOADER
        ====================================================== */
        const FeedbackLoader = ({ answerObj, evaluation, sessionId }) => {
            const [loading, setLoading] = useState(false);
            const [feedback, setFeedback] = useState(answerObj.feedback);
            const alreadyLoaded = useRef(false);

            const fetchFeedback = async () => {
                if (alreadyLoaded.current || feedback) return;

                setLoading(true);
                try {
                    const res = await fetch("/api/feedback", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            session_id: sessionId,
                            question_number: answerObj.question_number,
                            question: answerObj.question,
                            correct_answer: answerObj.correct_answer,
                            user_answer: answerObj.answer,
                            evaluation
                        })
                    });

                    const data = await res.json();
                    setFeedback(data.feedback || "No se pudo generar feedback.");
                    answerObj.feedback = data.feedback;
                    alreadyLoaded.current = true;

                } catch (err) {
                    setFeedback("Error generando feedback.");
                }

                setLoading(false);
            };

            useEffect(() => {
                if (!answerObj.feedback) fetchFeedback();
            }, []);

            return (
                <div className="mt-4 p-4 border-l-4 border-purple-500 bg-purple-50 rounded-lg">
                    <h4 className="text-lg font-semibold text-purple-800 mb-2">Feedback del Modelo</h4>
                    {loading ? (
                        <p className="text-sm text-gray-700 italic">Generando feedback...</p>
                    ) : (
                        <p className="text-sm text-gray-700 whitespace-pre-line">{feedback}</p>
                    )}
                </div>
            );
        };

        /* ======================================================
           COMPONENTE: EXPLANATION LOADER
        ====================================================== */
        const ExplanationLoader = ({ answerObj, sessionId }) => {
            const [loading, setLoading] = useState(false);
            const [explanation, setExplanation] = useState(answerObj.explanation);
            const alreadyLoaded = useRef(false);

            const fetchExplanation = async () => {
                if (alreadyLoaded.current || explanation) return;

                setLoading(true);
                try {
                    const res = await fetch("/api/explanation", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            session_id: sessionId,
                            question_number: answerObj.question_number,
                            question: answerObj.question,
                            correct_answer: answerObj.correct_answer
                        })
                    });

                    const data = await res.json();
                    setExplanation(data.explanation || "No se pudo generar explicaci칩n.");
                    answerObj.explanation = data.explanation;
                    alreadyLoaded.current = true;

                } catch (err) {
                    setExplanation("Error generando explicaci칩n.");
                }
                setLoading(false);
            };

            useEffect(() => {
                if (!answerObj.explanation) fetchExplanation();
            }, []);

            useEffect(() => {
                if (explanation) {
                    const container = document.getElementById(`exp-${answerObj.question_number}`);
                    if (container) {
                        container.innerHTML = marked.parse(explanation);
                        renderMathInElement(container, {
                            delimiters: [
                                { left: "$", right: "$", display: false },
                                { left: "$$", right: "$$", display: true },
                                { left: "\\(", right: "\\)", display: false },
                                { left: "\\[", right: "\\]", display: true }
                            ]
                        });
                    }
                }
            }, [explanation]);

            return (
                <div className="mt-4 p-4 border-l-4 border-orange-500 bg-orange-50 rounded-lg">
                    <h4 className="text-lg font-semibold text-orange-800 mb-2">Explicaci칩n Paso a Paso</h4>
                    {loading ? (
                        <p className="text-sm text-gray-700 italic">Generando explicaci칩n...</p>
                    ) : (
                        <div id={`exp-${answerObj.question_number}`} className="text-sm text-gray-700 prose"></div>
                    )}
                </div>
            );
        };

        /* ======================================================
           NUEVO COMPONENTE: THEORY LOADER (RAG Gemini)
        ====================================================== */
        const TheoryLoader = ({ question, questionNumber }) => {
            const [loading, setLoading] = useState(false);
            const [theory, setTheory] = useState(null);
            const alreadyLoaded = useRef(false);

            const fetchTheory = async () => {
                if (alreadyLoaded.current || theory) return;

                setLoading(true);
                try {
                    const res = await fetch("/api/theory", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ question: question })
                    });

                    const data = await res.json();
                    setTheory(data.theory || "No se pudo recuperar la teor칤a.");
                    alreadyLoaded.current = true;

                } catch (err) {
                    setTheory("Error conectando con la biblioteca de teor칤a.");
                }
                setLoading(false);
            };

            useEffect(() => {
                fetchTheory(); // Cargar autom치ticamente al abrir el panel
            }, []);

            useEffect(() => {
                if (theory) {
                    const container = document.getElementById(`theory-${questionNumber}`);
                    if (container) {
                        container.innerHTML = marked.parse(theory);
                        renderMathInElement(container, {
                            delimiters: [
                                { left: "$", right: "$", display: false },
                                { left: "$$", right: "$$", display: true },
                                { left: "\\(", right: "\\)", display: false },
                                { left: "\\[", right: "\\]", display: true }
                            ]
                        });
                    }
                }
            }, [theory]);

            return (
                <div className="mt-4 p-4 border-l-4 border-teal-500 bg-teal-50 rounded-lg">
                    <h4 className="text-lg font-semibold text-teal-800 mb-2">游닄 Teor칤a Subyacente (Biblioteca)</h4>
                    {loading ? (
                        <div className="flex items-center space-x-2">
                            <svg className="animate-spin h-5 w-5 text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p className="text-sm text-gray-700 italic">Consultando libros...</p>
                        </div>
                    ) : (
                        <div id={`theory-${questionNumber}`} className="text-sm text-gray-700 prose"></div>
                    )}
                </div>
            );
        };

        /* ======================================================
           VISTA PRINCIPAL
        ====================================================== */
        const ResultsPage = ({ data }) => {
            const { bleu, rouge, bertscore, answers, total_questions, dataset_type, evaluations } = data;

            return (
                <div className="max-w-5xl mx-auto">
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-gray-800">Resultados de la Entrevista</h1>
                        <p className="text-gray-600 mt-2">Evaluaci칩n autom치tica con m칠tricas NLP</p>
                        {dataset_type && (
                            <div className="inline-block mt-3 px-4 py-2 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
                                Dataset: {dataset_type.toUpperCase()}
                            </div>
                        )}
                    </div>

                    {/* M칠tricas */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                        <MetricCard title="BLEU" value={bleu} color="border-blue-500" desc="Similitud l칠xica" />
                        <MetricCard title="ROUGE-L" value={rouge.rougeL} color="border-green-500" desc="Secuencia com칰n m치s larga" />
                        <MetricCard title="BERTScore (F1)" value={bertscore} color="border-purple-500" desc="Similitud sem치ntica" />
                    </div>

                    {/* RESPUESTAS */}
                    <div className="bg-white rounded-xl shadow-lg p-6">
                        <h2 className="text-xl font-semibold mb-4">Respuestas Completas ({total_questions})</h2>
                        <div className="space-y-4">
                            {answers.map((a, i) => {
                                const evalData = evaluations[i];
                                const [showEval, setShowEval] = useState(false);
                                const [showFeedback, setShowFeedback] = useState(false);
                                const [showExplanation, setShowExplanation] = useState(false);
                                const [showTheory, setShowTheory] = useState(false); // Nuevo estado

                                return (
                                    <details key={i} className="border rounded-lg p-4 bg-gray-50">
                                        <summary className="font-medium cursor-pointer text-indigo-700">
                                            Pregunta {a.question_number}: {a.question}
                                        </summary>

                                        <div className="mt-3 pl-4 border-l-2 border-indigo-300">
                                            <p className="text-sm text-gray-700">
                                                <strong>Tu respuesta:</strong> {a.answer}
                                            </p>
                                            {a.correct_answer && (
                                                <p className="text-sm text-green-700 mt-2">
                                                    <strong>Respuesta correcta:</strong> {a.correct_answer}
                                                </p>
                                            )}

                                            {/* BOTONES */}
                                            <div className="mt-4 flex gap-3 flex-wrap">
                                                <button onClick={() => setShowEval(!showEval)} className="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                                                    {showEval ? "Ocultar Evaluaci칩n" : "Ver Evaluaci칩n"}
                                                </button>
                                                <button onClick={() => setShowFeedback(!showFeedback)} className="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
                                                    {showFeedback ? "Ocultar Feedback" : "Ver Feedback"}
                                                </button>
                                                <button onClick={() => setShowExplanation(!showExplanation)} className="px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700">
                                                    {showExplanation ? "Ocultar Explicaci칩n" : "Ver Explicaci칩n Paso a Paso"}
                                                </button>
                                                {/* Bot칩n Nuevo: Teor칤a */}
                                                <button onClick={() => setShowTheory(!showTheory)} className="px-4 py-2 bg-teal-600 text-white text-sm rounded-lg hover:bg-teal-700">
                                                    {showTheory ? "Ocultar Teor칤a" : "游닄 Ver Teor칤a (Libros)"}
                                                </button>
                                            </div>

                                            {/* PANELES */}
                                            {showEval && (
                                                <div className="mt-4 p-4 border-l-4 border-blue-500 bg-blue-50 rounded-lg">
                                                    <h4 className="text-lg font-semibold text-blue-800 mb-2">Evaluaci칩n NLP</h4>
                                                    <ul className="text-sm text-gray-800 space-y-1">
                                                        <li><strong>Similitud SBERT:</strong> {evalData.semantic_similarity.toFixed(3)}</li>
                                                        <li><strong>Validaci칩n Matem치tica:</strong> {evalData.numeric_score.toFixed(1)}</li>
                                                        <li><strong>Keyword coverage:</strong> {evalData.concept_coverage.toFixed(3)}</li>
                                                        <li><strong>Reasoning score:</strong> {evalData.reasoning_structure.toFixed(3)}</li>
                                                        <li><strong>Score final:</strong> {evalData.final_score.toFixed(3)}</li>
                                                    </ul>
                                                </div>
                                            )}

                                            {showFeedback && (
                                                <FeedbackLoader answerObj={a} evaluation={evalData} sessionId={data.session_id} />
                                            )}

                                            {showExplanation && (
                                                <ExplanationLoader answerObj={a} sessionId={data.session_id} />
                                            )}

                                            {/* Panel Nuevo: Teor칤a */}
                                            {showTheory && (
                                                <TheoryLoader question={a.question} questionNumber={a.question_number} />
                                            )}

                                        </div>
                                    </details>
                                );
                            })}
                        </div>
                    </div>

                    <div className="text-center mt-8">
                        <a href="/" className="inline-block px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                            Volver al inicio
                        </a>
                    </div>
                </div>
            );
        };

        /* ------------------------------------------------------ */
        const rawData = JSON.parse(document.getElementById('initial-data').textContent);
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ResultsPage data={rawData} />);
    </script>
</body>

</html>